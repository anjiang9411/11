import { useState } from 'react';
import { ArrowLeft, ChevronRight, MoreHorizontal, UserPlus, Star, Ban, Trash2, Home, BookOpen, FileText, Brain, ImagePlus, Upload, Link2, X as XIcon, List } from 'lucide-react';
import { Avatar, AvatarImage, AvatarFallback } from './ui/avatar';
import { ScrollArea } from './ui/scroll-area';
import { Button } from './ui/button';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from './ui/dialog';
import { Switch } from './ui/switch';
import { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle } from './ui/alert-dialog';
import { toast } from 'sonner@2.0.3';
import { Contact, AvatarItem } from './Contacts';
import { WorldBook } from './WorldBookManager';
import { Rule } from './RulesManager';
import { MomentPost } from './Moments';
import { Input } from './ui/input';
import { Label } from './ui/label';
import { Checkbox } from './ui/checkbox';
import { Textarea } from './ui/textarea';
import { ImageWithFallback } from './figma/ImageWithFallback';

interface GroupInfo {
  id: string;
  name: string;
}

interface ContactProfileProps {
  contact: Contact;
  onClose: () => void;
  wechatId?: string; // å¾®ä¿¡å·ï¼ˆå¯é€‰ï¼‰
  region?: string; // åœ°åŒºï¼ˆå¯é€‰ï¼‰
  onSendMessage?: () => void; // ç‚¹å‡»å‘æ¶ˆæ¯æŒ‰é’®çš„å›è°ƒ
  onVideoCall?: () => void; // ç‚¹å‡»è§†é¢‘é€šè¯æŒ‰é’®çš„å›è°ƒ
  commonGroups?: GroupInfo[]; // å…±åŒç¾¤èŠ
  signature?: string; // ä¸ªæ€§ç­¾å
  onContactUpdate?: (contact: Contact) => void; // æ›´æ–°è”ç³»äººä¿¡æ¯çš„å›è°ƒ
  onContactDelete?: (contactId: string) => void; // åˆ é™¤è”ç³»äººçš„å›è°ƒ
  worldBooks?: WorldBook[]; // æ‰€æœ‰å¯ç”¨çš„ä¸–ç•Œä¹¦
  rules?: Rule[]; // æ‰€æœ‰å¯ç”¨çš„è§„åˆ™
  moments?: MomentPost[]; // æ‰€æœ‰æœ‹å‹åœˆæ•°æ®
  onMomentsClick?: () => void; // ç‚¹å‡»æœ‹å‹åœˆæŸ¥çœ‹æ›´å¤šçš„å›è°ƒ
  summaries?: { id: string; timestamp: number; content: string; isAutoGenerated: boolean }[]; // è§’è‰²æ€»ç»“
}

export function ContactProfile({ contact, onClose, wechatId, region, onSendMessage, onVideoCall, commonGroups = [], signature, onContactUpdate, onContactDelete, worldBooks = [], rules = [], moments = [], onMomentsClick, summaries = [] }: ContactProfileProps) {
  const [showProfileDetail, setShowProfileDetail] = useState(false);
  const [showSettingsPage, setShowSettingsPage] = useState(false);
  const [showDeleteDialog, setShowDeleteDialog] = useState(false);
  const [showAiSettings, setShowAiSettings] = useState(false);
  const [isStarred, setIsStarred] = useState(contact.isStarred || false);
  const [isBlacklisted, setIsBlacklisted] = useState(contact.isBlacklisted || false);
  
  // AIè®¾ç½®çŠ¶æ€
  const [contextMemoryCount, setContextMemoryCount] = useState(contact.contextMemoryCount || 10);
  const [selectedWorldBooks, setSelectedWorldBooks] = useState<string[]>(contact.worldBooks || []);
  const [selectedRules, setSelectedRules] = useState<string[]>(contact.rules || []);
  
  // å¤´åƒåº“ç›¸å…³çŠ¶æ€
  const [showAvatarLibrary, setShowAvatarLibrary] = useState(false);
  const [showAddAvatar, setShowAddAvatar] = useState(false);
  const [avatarLibrary, setAvatarLibrary] = useState<AvatarItem[]>(contact.avatarLibrary || []);
  const [newAvatar, setNewAvatar] = useState({ url: '', emotion: '', description: '' });
  const [avatarUploadMethod, setAvatarUploadMethod] = useState<'url' | 'upload'>('url');
  const [avatarLocalFile, setAvatarLocalFile] = useState<File | null>(null);
  const [avatarLocalPreview, setAvatarLocalPreview] = useState<string>('');
  const avatarFileInputRef = useState<HTMLInputElement | null>(null)[0];
  
  const formatTime = (timestamp: number) => {
    const now = Date.now();
    const diff = now - timestamp;
    const days = Math.floor(diff / 86400000);
    
    if (days === 0) return 'ä»Šå¤©';
    if (days === 1) return 'æ˜¨å¤©';
    if (days < 7) return `${days}å¤©å‰`;
    
    const date = new Date(timestamp);
    return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
  };

  // å¤„ç†æ˜Ÿæ ‡æœ‹å‹åˆ‡æ¢
  const handleStarToggle = (checked: boolean) => {
    setIsStarred(checked);
    if (onContactUpdate) {
      onContactUpdate({ ...contact, isStarred: checked });
    }
    toast.success(checked ? 'å·²è®¾ä¸ºæ˜Ÿæ ‡æœ‹å‹' : 'å·²å–æ¶ˆæ˜Ÿæ ‡æœ‹å‹');
  };

  // å¤„ç†é»‘åå•åˆ‡æ¢
  const handleBlacklistToggle = (checked: boolean) => {
    setIsBlacklisted(checked);
    if (onContactUpdate) {
      onContactUpdate({ ...contact, isBlacklisted: checked });
    }
    toast.success(checked ? 'å·²åŠ å…¥é»‘åå•' : 'å·²ç§»å‡ºé»‘åå•');
  };

  // å¤„ç†åˆ é™¤å¥½å‹
  const handleDeleteContact = () => {
    if (onContactDelete) {
      onContactDelete(contact.id);
      toast.success('å·²åˆ é™¤å¥½å‹');
      onClose();
    }
    setShowDeleteDialog(false);
  };

  // å¤„ç†æ¨èç»™æœ‹å‹
  const handleRecommend = () => {
    toast.success('æ¨èåŠŸèƒ½å¼€å‘ä¸­');
  };

  // å¤„ç†æ·»åŠ åˆ°æ¡Œé¢
  const handleAddToHome = () => {
    toast.success('å·²æ·»åŠ åˆ°æ¡Œé¢');
  };

  // å¤„ç†å¤´åƒæœ¬åœ°æ–‡ä»¶ä¸Šä¼ 
  const handleAvatarFileUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    if (!file.type.startsWith('image/')) {
      toast.error('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
      return;
    }

    if (file.size > 5 * 1024 * 1024) {
      toast.error('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MB');
      return;
    }

    setAvatarLocalFile(file);

    const reader = new FileReader();
    reader.onload = (event) => {
      if (event.target?.result) {
        setAvatarLocalPreview(event.target.result as string);
        setNewAvatar({ ...newAvatar, url: event.target.result as string });
      }
    };
    reader.readAsDataURL(file);
  };

  // æ·»åŠ å¤´åƒåˆ°åº“
  const handleAddAvatarToLibrary = () => {
    if (!newAvatar.url.trim()) {
      toast.error('è¯·è¾“å…¥å¤´åƒURLæˆ–ä¸Šä¼ å›¾ç‰‡');
      return;
    }
    if (!newAvatar.emotion.trim()) {
      toast.error('è¯·è¾“å…¥æƒ…ç»ª/åœºæ™¯æ ‡ç­¾');
      return;
    }
    if (!newAvatar.description.trim()) {
      toast.error('è¯·è¾“å…¥æè¿°');
      return;
    }

    const newAvatarItem: AvatarItem = {
      id: Date.now().toString(),
      url: newAvatar.url.trim(),
      emotion: newAvatar.emotion.trim(),
      description: newAvatar.description.trim(),
    };

    setAvatarLibrary([...avatarLibrary, newAvatarItem]);
    toast.success('å¤´åƒå·²æ·»åŠ ');
    
    // é‡ç½®è¡¨å•
    setNewAvatar({ url: '', emotion: '', description: '' });
    setAvatarLocalFile(null);
    setAvatarLocalPreview('');
    setShowAddAvatar(false);
  };

  // åˆ é™¤å¤´åƒ
  const handleDeleteAvatar = (id: string) => {
    setAvatarLibrary(avatarLibrary.filter(a => a.id !== id));
    toast.success('å¤´åƒå·²åˆ é™¤');
  };

  // ä¿å­˜å¤´åƒåº“
  const handleSaveAvatarLibrary = () => {
    if (onContactUpdate) {
      onContactUpdate({
        ...contact,
        avatarLibrary
      });
    }
    toast.success('å¤´åƒåº“å·²ä¿å­˜');
    setShowAvatarLibrary(false);
  };
  
  // å¦‚æœæ˜¾ç¤ºè®¾ç½®é¡µé¢
  if (showSettingsPage) {
    return (
      <div className="fixed inset-0 bg-[#EDEDED] z-[70] flex flex-col">
        {/* é¡¶éƒ¨å¯¼èˆªæ  */}
        <div className="flex items-center justify-between px-4 py-3 bg-[#F7F7F7] border-b border-gray-200">
          <button
            onClick={() => setShowSettingsPage(false)}
            className="p-2 hover:bg-gray-200 rounded-full transition-colors -ml-2"
          >
            <ArrowLeft className="w-5 h-5" />
          </button>
          <h1 className="absolute left-1/2 -translate-x-1/2">è®¾ç½®</h1>
          <div className="w-9"></div>
        </div>

        {/* è®¾ç½®é€‰é¡¹ */}
        <ScrollArea className="flex-1">
          {/* ç¬¬ä¸€ç»„ */}
          <div className="mt-3 bg-white">
            <button
              onClick={handleRecommend}
              className="w-full px-4 py-3 flex items-center justify-between hover:bg-gray-50 transition-colors border-b border-gray-100"
            >
              <span>æŠŠä»–ï¼ˆå¥¹ï¼‰æ¨èç»™æœ‹å‹</span>
              <ChevronRight className="w-4 h-4 text-gray-400" />
            </button>

            <button
              onClick={handleAddToHome}
              className="w-full px-4 py-3 flex items-center justify-between hover:bg-gray-50 transition-colors"
            >
              <span>æ·»åŠ åˆ°æ¡Œé¢</span>
              <ChevronRight className="w-4 h-4 text-gray-400" />
            </button>
          </div>

          {/* ç¬¬äºŒç»„ */}
          <div className="mt-3 bg-white">
            <div className="px-4 py-3 flex items-center justify-between border-b border-gray-100">
              <span>è®¾ä¸ºæ˜Ÿæ ‡æœ‹å‹</span>
              <Switch
                checked={isStarred}
                onCheckedChange={handleStarToggle}
              />
            </div>

            <div className="px-4 py-3 flex items-center justify-between">
              <span>åŠ å…¥é»‘åå•</span>
              <Switch
                checked={isBlacklisted}
                onCheckedChange={handleBlacklistToggle}
              />
            </div>
          </div>

          {/* åˆ é™¤å¥½å‹ */}
          <div className="mt-3 bg-white">
            <button
              onClick={() => setShowDeleteDialog(true)}
              className="w-full px-4 py-3 text-center hover:bg-gray-50 transition-colors"
            >
              <span className="text-red-600">åˆ é™¤</span>
            </button>
          </div>
        </ScrollArea>

        {/* åˆ é™¤å¥½å‹ç¡®è®¤å¯¹è¯æ¡† */}
        <AlertDialog open={showDeleteDialog} onOpenChange={setShowDeleteDialog}>
          <AlertDialogContent className="max-w-[270px] rounded-xl p-0">
            <div className="pt-6 pb-4 px-6 text-center">
              <div className="mb-2">åˆ é™¤è”ç³»äºº</div>
              <div className="text-sm text-gray-500">
                å°†è”ç³»äºº"{contact.remark || contact.nickname}"åˆ é™¤ï¼Œå°†åŒæ—¶åˆ é™¤ä¸è¯¥è”ç³»äººçš„èŠå¤©è®°å½•
              </div>
            </div>
            <div className="border-t border-gray-200 flex">
              <button
                onClick={() => setShowDeleteDialog(false)}
                className="flex-1 py-3 text-blue-600 border-r border-gray-200 hover:bg-gray-50 transition-colors"
              >
                å–æ¶ˆ
              </button>
              <button
                onClick={handleDeleteContact}
                className="flex-1 py-3 text-red-600 hover:bg-gray-50 transition-colors"
              >
                åˆ é™¤
              </button>
            </div>
          </AlertDialogContent>
        </AlertDialog>
      </div>
    );
  }

  return (
    <div className="fixed inset-0 bg-white z-[60] flex flex-col">
      {/* é¡¶éƒ¨å¯¼èˆªæ  */}
      <div className="flex items-center justify-between px-4 py-3 border-b bg-white">
        <button
          onClick={onClose}
          className="p-2 hover:bg-gray-100 rounded-full transition-colors"
        >
          <ArrowLeft className="w-6 h-6" />
        </button>
        <h1 className="text-lg">è¯¦ç»†èµ„æ–™</h1>
        <button 
          onClick={() => setShowSettingsPage(true)}
          className="p-2 hover:bg-gray-100 rounded-full transition-colors"
        >
          <MoreHorizontal className="w-6 h-6" />
        </button>
      </div>

      {/* ä¸»å†…å®¹åŒºåŸŸ */}
      <ScrollArea className="flex-1">
        <div className="pb-6">
          {/* å¤´åƒå’ŒåŸºæœ¬ä¿¡æ¯åŒºåŸŸ */}
          <div className="bg-white px-4 py-6">
            <div className="flex items-start gap-4">
              {/* å·¦ä¾§å¤´åƒ */}
              <Avatar className="w-16 h-16 shrink-0 rounded-md">
                <AvatarImage src={contact.avatar} />
                <AvatarFallback className="rounded-md">{contact.nickname[0]}</AvatarFallback>
              </Avatar>
              
              {/* å³ä¾§ä¿¡æ¯ */}
              <div className="flex-1 min-w-0">
                {/* å¤‡æ³¨å - åŠ ç²—æ˜¾ç¤º */}
                <div className="mb-1">
                  <span className="text-xl font-bold">
                    {contact.remark || contact.nickname}
                  </span>
                </div>
                
                {/* æ˜µç§° */}
                <div className="text-gray-500 mb-1">
                  <span className="text-sm">
                    æ˜µç§°ï¼š{contact.nickname}
                  </span>
                </div>
                
                {/* AIç»™ä½ çš„å¤‡æ³¨å */}
                <div className={`mb-1 ${contact.userRemark ? 'text-purple-600' : 'text-gray-400'}`}>
                  <span className="text-sm">
                    Taç»™ä½ çš„å¤‡æ³¨ï¼š{contact.userRemark || 'æš‚æœªè®¾ç½®'}
                  </span>
                </div>
                
                {/* å¾®ä¿¡å· */}
                <div className="text-gray-500 mb-1">
                  <span className="text-sm">
                    å¾®ä¿¡å·ï¼š{wechatId || contact.id}
                  </span>
                </div>
                
                {/* åœ°åŒº */}
                <div className="text-gray-500">
                  <span className="text-sm">
                    åœ°åŒºï¼š{region || contact.location || 'æœªè®¾ç½®'}
                  </span>
                </div>
              </div>
            </div>
            
            {/* ä¸ªæ€§ç­¾å */}
            <div className="mt-4 px-3 py-2 bg-gray-50 rounded-lg">
              <div className="text-sm text-gray-600 whitespace-pre-wrap">
                {signature || 'è¿™ä¸ªäººå¾ˆç¥ç§˜ï¼Œä»€ä¹ˆéƒ½æ²¡æœ‰å†™'}
              </div>
            </div>
          </div>

          {/* åˆ†éš”çº¿ */}
          <div className="h-2 bg-gray-100"></div>

          {/* AIè®¾ç½® */}
          <div className="bg-white">
            <button 
              onClick={() => setShowAiSettings(true)}
              className="w-full px-4 py-3 flex items-center justify-between hover:bg-gray-50 transition-colors"
            >
              <div className="flex items-center gap-2">
                <Brain className="w-5 h-5 text-purple-600" />
                <span>AIè®¾ç½®</span>
              </div>
              <ChevronRight className="w-5 h-5 text-gray-400" />
            </button>
          </div>

          {/* åˆ†éš”çº¿ */}
          <div className="h-2 bg-gray-100"></div>

          {/* æœ‹å‹èµ„æ–™ */}
          <div className="bg-white">
            <button 
              onClick={() => setShowProfileDetail(true)}
              className="w-full px-4 py-3 flex items-center justify-between hover:bg-gray-50 transition-colors"
            >
              <span>æœ‹å‹èµ„æ–™</span>
              <ChevronRight className="w-5 h-5 text-gray-400" />
            </button>
          </div>

          {/* åˆ†éš”çº¿ */}
          <div className="h-2 bg-gray-100"></div>

          {/* æœ‹å‹æƒé™ */}
          <div className="bg-white">
            <button className="w-full px-4 py-3 flex items-center justify-between hover:bg-gray-50 transition-colors">
              <span>æœ‹å‹æƒé™</span>
              <ChevronRight className="w-5 h-5 text-gray-400" />
            </button>
            
            <div className="px-4 py-2 border-t border-gray-100">
              <div className="flex items-center justify-between py-2">
                <span className="text-sm text-gray-600">èŠå¤©ã€æœ‹å‹åœˆã€å¾®ä¿¡è¿åŠ¨ç­‰</span>
              </div>
            </div>
          </div>

          {/* åˆ†éš”çº¿ */}
          <div className="h-2 bg-gray-100"></div>

          {/* æœ‹å‹åœˆ */}
          <div className="bg-white">
            <button 
              onClick={onMomentsClick}
              className="w-full px-4 py-3 flex items-center justify-between hover:bg-gray-50 transition-colors"
            >
              <span>æœ‹å‹åœˆ</span>
              <div className="flex items-center gap-2">
                {moments.length > 0 && moments[0].images && moments[0].images.length > 0 && (
                  <div className="w-12 h-12 rounded overflow-hidden">
                    <img 
                      src={moments[0].images[0]} 
                      alt="" 
                      className="w-full h-full object-cover"
                    />
                  </div>
                )}
                <ChevronRight className="w-5 h-5 text-gray-400" />
              </div>
            </button>
          </div>

          {/* åº•éƒ¨æ“ä½œæŒ‰é’® */}
          <div className="px-4 py-4 space-y-2">
            <Button 
              className="w-full bg-green-500 hover:bg-green-600" 
              onClick={() => {
                onClose();
                if (onSendMessage) {
                  onSendMessage();
                }
              }}
            >
              å‘æ¶ˆæ¯
            </Button>
            <Button 
              className="w-full" 
              variant="outline" 
              onClick={() => {
                onClose();
                if (onVideoCall) {
                  onVideoCall();
                }
              }}
            >
              éŸ³è§†é¢‘é€šè¯
            </Button>
          </div>
        </div>
      </ScrollArea>

      {/* æœ‹å‹èµ„æ–™è¯¦æƒ…å¯¹è¯æ¡† */}
      <Dialog open={showProfileDetail} onOpenChange={setShowProfileDetail}>
        <DialogContent className="max-w-md max-h-[80vh] overflow-hidden flex flex-col">
          <DialogHeader>
            <DialogTitle>æœ‹å‹èµ„æ–™</DialogTitle>
            <DialogDescription>
              æŸ¥çœ‹ {contact.remark || contact.nickname} çš„è¯¦ç»†èµ„æ–™
            </DialogDescription>
          </DialogHeader>
          
          <ScrollArea className="flex-1 -mx-6 px-6">
            <div className="space-y-4 py-2">
              {/* ä¸ªæ€§ç­¾å */}
              {signature && (
                <div className="pb-4 border-b">
                  <div className="text-sm text-gray-500 mb-2">ä¸ªæ€§ç­¾å</div>
                  <div className="text-sm whitespace-pre-wrap bg-gray-50 p-3 rounded-lg">
                    {signature}
                  </div>
                </div>
              )}

              {/* æœ¬å */}
              {contact.realName && (
                <div className="pb-4 border-b">
                  <div className="text-sm text-gray-500 mb-2">æœ¬å</div>
                  <div className="text-sm">{contact.realName}</div>
                </div>
              )}
              
              {/* å¹´é¾„ */}
              {contact.age && (
                <div className="pb-4 border-b">
                  <div className="text-sm text-gray-500 mb-2">å¹´é¾„</div>
                  <div className="text-sm">{contact.age}</div>
                </div>
              )}
              
              {/* èŒä¸š */}
              {contact.occupation && (
                <div className="pb-4 border-b">
                  <div className="text-sm text-gray-500 mb-2">èŒä¸š</div>
                  <div className="text-sm">{contact.occupation}</div>
                </div>
              )}
              
              {/* æ€§æ ¼ */}
              {contact.personality && (
                <div className="pb-4 border-b">
                  <div className="text-sm text-gray-500 mb-2">æ€§æ ¼</div>
                  <div className="text-sm whitespace-pre-wrap">{contact.personality}</div>
                </div>
              )}
              
              {/* å…´è¶£çˆ±å¥½ */}
              {contact.hobbies && (
                <div className="pb-4 border-b">
                  <div className="text-sm text-gray-500 mb-2">å…´è¶£çˆ±å¥½</div>
                  <div className="text-sm whitespace-pre-wrap">{contact.hobbies}</div>
                </div>
              )}

              {/* å…±åŒç¾¤èŠ */}
              {commonGroups.length > 0 && (
                <div>
                  <div className="text-sm text-gray-500 mb-2">
                    å…±åŒç¾¤èŠ ({commonGroups.length})
                  </div>
                  <div className="space-y-2">
                    {commonGroups.map((group) => (
                      <div 
                        key={group.id}
                        className="flex items-center gap-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors cursor-pointer"
                      >
                        <div className="w-10 h-10 bg-gray-300 rounded-lg flex items-center justify-center">
                          <span className="text-sm">ç¾¤</span>
                        </div>
                        <span className="text-sm flex-1">{group.name}</span>
                        <ChevronRight className="w-4 h-4 text-gray-400" />
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* è§’è‰²æ€»ç»“ */}
              {summaries && summaries.length > 0 && (
                <div className="pb-4 border-b">
                  <div className="flex items-center gap-2 mb-3">
                    <List className="w-4 h-4 text-purple-600" />
                    <div className="text-sm text-gray-500">
                      èŠå¤©æ€»ç»“ ({summaries.length})
                    </div>
                  </div>
                  <div className="space-y-3">
                    {summaries.slice().reverse().map((summary, index) => (
                      <div 
                        key={summary.id}
                        className="p-3 bg-gradient-to-br from-purple-50 to-blue-50 rounded-lg border border-purple-100"
                      >
                        <div className="flex items-center justify-between mb-2">
                          <span className="text-xs text-purple-600 font-medium">
                            æ€»ç»“ #{summaries.length - index}
                          </span>
                          <span className="text-xs text-gray-400">
                            {formatTime(summary.timestamp)}
                          </span>
                        </div>
                        <p className="text-sm text-gray-700 whitespace-pre-wrap leading-relaxed">
                          {summary.content}
                        </p>
                      </div>
                    ))}
                  </div>
                  <p className="text-xs text-gray-400 mt-3 text-center">
                    ğŸ’¡ è¿™äº›æ˜¯AIæ ¹æ®èŠå¤©è®°å½•ç”Ÿæˆçš„æ€»ç»“
                  </p>
                </div>
              )}
            </div>
          </ScrollArea>
        </DialogContent>
      </Dialog>

      {/* AIè®¾ç½®å¯¹è¯æ¡† */}
      <Dialog open={showAiSettings} onOpenChange={setShowAiSettings}>
        <DialogContent className="max-w-md max-h-[85vh] overflow-hidden flex flex-col">
          <DialogHeader>
            <DialogTitle>AIè®¾ç½®</DialogTitle>
            <DialogDescription>
              é…ç½® {contact.remark || contact.nickname} çš„AIè¡Œä¸ºå’Œè®°å¿†è®¾ç½®
            </DialogDescription>
          </DialogHeader>
          
          <ScrollArea className="flex-1 pr-4">
            <div className="space-y-6 py-2">
              {/* ä¸Šä¸‹æ–‡è®°å¿†æ¡æ•° */}
              <div>
                <Label htmlFor="contextMemoryCount">ä¸Šä¸‹æ–‡è®°å¿†æ¡æ•°</Label>
                <div className="flex items-center gap-3 mt-2">
                  <Input
                    id="contextMemoryCount"
                    type="number"
                    min="1"
                    max="100"
                    value={contextMemoryCount}
                    onChange={(e) => setContextMemoryCount(parseInt(e.target.value) || 10)}
                    className="w-24"
                  />
                  <span className="text-sm text-gray-600">æ¡æ¶ˆæ¯</span>
                </div>
                <p className="text-xs text-gray-500 mt-2">
                  AIå¯ä»¥çœ‹åˆ°æœ€è¿‘çš„{contextMemoryCount}æ¡èŠå¤©è®°å½•ï¼Œæ•°å€¼è¶Šå¤§ï¼ŒAIçš„è®°å¿†è¶Šé•¿
                </p>
              </div>

              {/* å…³è”ä¸–ç•Œä¹¦ */}
              <div className="pb-4 border-b">
                <div className="flex items-center gap-2 mb-3">
                  <BookOpen className="w-4 h-4 text-blue-600" />
                  <Label>å…³è”ä¸–ç•Œä¹¦</Label>
                </div>
                {worldBooks.length === 0 ? (
                  <p className="text-sm text-gray-400">æš‚æ— å¯ç”¨çš„ä¸–ç•Œä¹¦</p>
                ) : (
                  <div className="space-y-2">
                    {worldBooks.map((book) => (
                      <div
                        key={book.id}
                        className="flex items-start gap-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors"
                      >
                        <Checkbox
                          checked={selectedWorldBooks.includes(book.id)}
                          onCheckedChange={(checked) => {
                            if (checked) {
                              setSelectedWorldBooks([...selectedWorldBooks, book.id]);
                            } else {
                              setSelectedWorldBooks(selectedWorldBooks.filter(id => id !== book.id));
                            }
                          }}
                          className="mt-1"
                        />
                        <div className="flex-1 min-w-0">
                          <div className="font-medium text-sm mb-1">{book.name}</div>
                          {book.description && (
                            <p className="text-xs text-gray-500">{book.description}</p>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                )}
                <p className="text-xs text-gray-500 mt-3">
                  å·²é€‰æ‹© {selectedWorldBooks.length} ä¸ªä¸–ç•Œä¹¦ã€‚AIä¼šåœ¨å›å¤æ—¶å‚è€ƒè¿™äº›èƒŒæ™¯è®¾å®šå’Œä¸–ç•Œè§‚ã€‚
                </p>
              </div>

              {/* å…³è”è§„åˆ™ */}
              <div className="pb-4 border-b">
                <div className="flex items-center gap-2 mb-3">
                  <FileText className="w-4 h-4 text-blue-600" />
                  <Label>å…³è”è§„åˆ™</Label>
                </div>
                {rules.length === 0 ? (
                  <p className="text-sm text-gray-400">æš‚æ— å¯ç”¨çš„è§„åˆ™</p>
                ) : (
                  <div className="space-y-2">
                    {rules.map((rule) => (
                      <div
                        key={rule.id}
                        className="flex items-start gap-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors"
                      >
                        <Checkbox
                          checked={selectedRules.includes(rule.id)}
                          onCheckedChange={(checked) => {
                            if (checked) {
                              setSelectedRules([...selectedRules, rule.id]);
                            } else {
                              setSelectedRules(selectedRules.filter(id => id !== rule.id));
                            }
                          }}
                          className="mt-1"
                        />
                        <div className="flex-1 min-w-0">
                          <div className="font-medium text-sm mb-1">{rule.name}</div>
                          {rule.description && (
                            <p className="text-xs text-gray-500">{rule.description}</p>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                )}
                <p className="text-xs text-gray-500 mt-3">
                  å·²é€‰æ‹© {selectedRules.length} ä¸ªè§„åˆ™ã€‚AIä¼šåœ¨å›å¤æ—¶å‚è€ƒè¿™äº›è§„åˆ™ã€‚
                </p>
              </div>

              {/* å¤´åƒåº“ç®¡ç† */}
              <div className="pb-4 border-b">
                <div className="flex items-center justify-between mb-3">
                  <div className="flex items-center gap-2">
                    <ImagePlus className="w-4 h-4 text-blue-600" />
                    <Label>è§’è‰²å¤´åƒåº“</Label>
                  </div>
                  <Button
                    type="button"
                    size="sm"
                    variant="outline"
                    onClick={() => setShowAvatarLibrary(true)}
                  >
                    ç®¡ç†å¤´åƒ
                  </Button>
                </div>
                <p className="text-xs text-gray-500">
                  ä¸ºè§’è‰²ä¸Šä¼ å¤šä¸ªå¤´åƒï¼ŒAIä¼šæ ¹æ®æƒ…ç»ªå’Œåœºæ™¯è‡ªåŠ¨åˆ‡æ¢å¤´åƒï¼ˆå½“å‰å¤´åƒæ•°ï¼š{avatarLibrary.length}ï¼‰
                </p>
              </div>
            </div>
          </ScrollArea>

          <div className="flex gap-2 pt-4 border-t">
            <Button
              type="button"
              variant="outline"
              onClick={() => {
                // æ¢å¤åˆ°åŸå§‹å€¼
                setContextMemoryCount(contact.contextMemoryCount || 10);
                setSelectedWorldBooks(contact.worldBooks || []);
                setSelectedRules(contact.rules || []);
                setAvatarLibrary(contact.avatarLibrary || []);
                setShowAiSettings(false);
              }}
              className="flex-1"
            >
              å–æ¶ˆ
            </Button>
            <Button
              type="button"
              onClick={() => {
                if (onContactUpdate) {
                  onContactUpdate({
                    ...contact,
                    contextMemoryCount,
                    worldBooks: selectedWorldBooks,
                    rules: selectedRules,
                    avatarLibrary
                  });
                }
                toast.success('AIè®¾ç½®å·²ä¿å­˜');
                setShowAiSettings(false);
              }}
              className="flex-1"
            >
              ä¿å­˜
            </Button>
          </div>
        </DialogContent>
      </Dialog>

      {/* å¤´åƒåº“ç®¡ç†å¯¹è¯æ¡† */}
      <Dialog open={showAvatarLibrary} onOpenChange={setShowAvatarLibrary}>
        <DialogContent className="max-w-md max-h-[85vh] overflow-hidden flex flex-col">
          <DialogHeader>
            <DialogTitle>è§’è‰²å¤´åƒåº“</DialogTitle>
            <DialogDescription>
              ä¸º {contact.remark || contact.nickname} æ·»åŠ å¤šä¸ªå¤´åƒï¼ŒAIä¼šæ ¹æ®æƒ…ç»ªå’Œåœºæ™¯è‡ªåŠ¨åˆ‡æ¢
            </DialogDescription>
          </DialogHeader>
          
          <ScrollArea className="flex-1 pr-4">
            <div className="space-y-4 py-2">
              {/* å½“å‰å¤´åƒå±•ç¤º */}
              <div className="pb-4 border-b">
                <div className="text-sm text-gray-500 mb-3">å½“å‰ä½¿ç”¨çš„å¤´åƒ</div>
                <div className="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                  <Avatar className="w-16 h-16">
                    <AvatarImage src={contact.avatar} />
                    <AvatarFallback>{contact.nickname[0]}</AvatarFallback>
                  </Avatar>
                  <div className="flex-1">
                    <div className="text-sm">é»˜è®¤å¤´åƒ</div>
                    <div className="text-xs text-gray-500 mt-1">åœ¨è§’è‰²è¯¦ç»†èµ„æ–™ä¸­è®¾ç½®</div>
                  </div>
                </div>
              </div>

              {/* å¤´åƒåº“åˆ—è¡¨ */}
              <div>
                <div className="flex items-center justify-between mb-3">
                  <div className="text-sm text-gray-500">
                    å¤´åƒåº“ ({avatarLibrary.length})
                  </div>
                  <Button
                    type="button"
                    size="sm"
                    onClick={() => setShowAddAvatar(true)}
                  >
                    <ImagePlus className="w-4 h-4 mr-1" />
                    æ·»åŠ å¤´åƒ
                  </Button>
                </div>

                {avatarLibrary.length === 0 ? (
                  <div className="text-center py-8 text-gray-400">
                    <ImagePlus className="w-12 h-12 mx-auto mb-2 opacity-50" />
                    <p>è¿˜æ²¡æœ‰æ·»åŠ å¤´åƒ</p>
                    <p className="text-xs mt-1">ç‚¹å‡»"æ·»åŠ å¤´åƒ"å¼€å§‹åˆ›å»ºå¤´åƒåº“</p>
                  </div>
                ) : (
                  <div className="space-y-2">
                    {avatarLibrary.map((avatar) => (
                      <div
                        key={avatar.id}
                        className="flex items-start gap-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors relative group"
                      >
                        {/* å¤´åƒ */}
                        <div className="w-16 h-16 shrink-0 rounded overflow-hidden">
                          <ImageWithFallback
                            src={avatar.url}
                            alt={avatar.emotion}
                            className="w-full h-full object-cover"
                          />
                        </div>

                        {/* ä¿¡æ¯ */}
                        <div className="flex-1 min-w-0">
                          <div className="flex items-center gap-2 mb-1">
                            <span className="inline-block px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded">
                              {avatar.emotion}
                            </span>
                          </div>
                          <p className="text-xs text-gray-600 whitespace-pre-wrap">
                            {avatar.description}
                          </p>
                        </div>

                        {/* åˆ é™¤æŒ‰é’® */}
                        <button
                          onClick={() => handleDeleteAvatar(avatar.id)}
                          className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity p-1 bg-red-500 text-white rounded-full hover:bg-red-600"
                        >
                          <XIcon className="w-4 h-4" />
                        </button>
                      </div>
                    ))}
                  </div>
                )}

                {avatarLibrary.length > 0 && (
                  <div className="mt-4 p-3 bg-blue-50 rounded-lg">
                    <div className="text-xs text-blue-900">
                      ğŸ’¡ <strong>ä½¿ç”¨æç¤ºï¼š</strong>
                    </div>
                    <ul className="text-xs text-blue-800 mt-2 space-y-1 ml-4 list-disc">
                      <li>AIä¼šæ ¹æ®å½“å‰æƒ…ç»ªå’Œåœºæ™¯é€‰æ‹©åˆé€‚çš„å¤´åƒ</li>
                      <li>å¤´åƒåˆ‡æ¢ä¸ä¼šå¾ˆé¢‘ç¹ï¼Œåªåœ¨æ˜æ˜¾çš„æƒ…ç»ªå˜åŒ–æ—¶</li>
                      <li>æè¿°è¶Šè¯¦ç»†ï¼ŒAIè¶Šèƒ½å‡†ç¡®åˆ¤æ–­ä½•æ—¶ä½¿ç”¨è¯¥å¤´åƒ</li>
                      <li>ä¾‹å¦‚ï¼š"å¼€å¿ƒç¬‘ç€"ã€"ç”Ÿæ°”çš±çœ‰"ã€"éš¾è¿‡å“­æ³£"ç­‰</li>
                    </ul>
                  </div>
                )}
              </div>
            </div>
          </ScrollArea>

          <div className="flex gap-2 pt-4 border-t">
            <Button
              type="button"
              variant="outline"
              onClick={() => {
                setAvatarLibrary(contact.avatarLibrary || []);
                setShowAvatarLibrary(false);
              }}
              className="flex-1"
            >
              å–æ¶ˆ
            </Button>
            <Button
              type="button"
              onClick={handleSaveAvatarLibrary}
              className="flex-1"
            >
              ä¿å­˜
            </Button>
          </div>
        </DialogContent>
      </Dialog>

      {/* æ·»åŠ å¤´åƒå¯¹è¯æ¡† */}
      <Dialog open={showAddAvatar} onOpenChange={(open) => {
        setShowAddAvatar(open);
        if (!open) {
          setNewAvatar({ url: '', emotion: '', description: '' });
          setAvatarLocalFile(null);
          setAvatarLocalPreview('');
          setAvatarUploadMethod('url');
        }
      }}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle>æ·»åŠ å¤´åƒ</DialogTitle>
            <DialogDescription>
              ä¸ºè§’è‰²æ·»åŠ æ–°çš„è¡¨æƒ…å¤´åƒ
            </DialogDescription>
          </DialogHeader>

          <div className="space-y-4 py-4">
            {/* ä¸Šä¼ æ–¹å¼é€‰æ‹© */}
            <div className="flex gap-2">
              <Button
                type="button"
                variant={avatarUploadMethod === 'url' ? 'default' : 'outline'}
                size="sm"
                onClick={() => setAvatarUploadMethod('url')}
                className="flex-1"
              >
                <Link2 className="w-4 h-4 mr-2" />
                URLé“¾æ¥
              </Button>
              <Button
                type="button"
                variant={avatarUploadMethod === 'upload' ? 'default' : 'outline'}
                size="sm"
                onClick={() => setAvatarUploadMethod('upload')}
                className="flex-1"
              >
                <Upload className="w-4 h-4 mr-2" />
                æœ¬åœ°ä¸Šä¼ 
              </Button>
            </div>

            {/* URLè¾“å…¥ */}
            {avatarUploadMethod === 'url' && (
              <div>
                <Label>å¤´åƒURL</Label>
                <Input
                  value={newAvatar.url}
                  onChange={(e) => setNewAvatar({ ...newAvatar, url: e.target.value })}
                  placeholder="https://example.com/avatar.png"
                  className="mt-2"
                />
              </div>
            )}

            {/* æœ¬åœ°ä¸Šä¼  */}
            {avatarUploadMethod === 'upload' && (
              <div>
                <Label>é€‰æ‹©å›¾ç‰‡</Label>
                <div className="mt-2">
                  <input
                    type="file"
                    accept="image/*"
                    onChange={handleAvatarFileUpload}
                    className="hidden"
                    id="avatar-file-upload"
                  />
                  <label
                    htmlFor="avatar-file-upload"
                    className="flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-lg p-6 cursor-pointer hover:border-gray-400 transition-colors"
                  >
                    {avatarLocalPreview ? (
                      <div className="flex flex-col items-center gap-2">
                        <ImageWithFallback
                          src={avatarLocalPreview}
                          alt="é¢„è§ˆ"
                          className="w-24 h-24 object-cover rounded"
                        />
                        <p className="text-sm text-gray-500">ç‚¹å‡»é‡æ–°é€‰æ‹©</p>
                      </div>
                    ) : (
                      <>
                        <Upload className="w-8 h-8 text-gray-400 mb-2" />
                        <span className="text-sm text-gray-500">ç‚¹å‡»é€‰æ‹©å›¾ç‰‡ï¼ˆæœ€å¤§5MBï¼‰</span>
                      </>
                    )}
                  </label>
                </div>
              </div>
            )}

            {/* æƒ…ç»ª/åœºæ™¯æ ‡ç­¾ */}
            <div>
              <Label>æƒ…ç»ª/åœºæ™¯æ ‡ç­¾</Label>
              <Input
                value={newAvatar.emotion}
                onChange={(e) => setNewAvatar({ ...newAvatar, emotion: e.target.value })}
                placeholder="ä¾‹å¦‚ï¼šå¼€å¿ƒã€ç”Ÿæ°”ã€éš¾è¿‡ã€é»˜è®¤"
                className="mt-2"
              />
              <p className="text-xs text-gray-500 mt-1">
                ç®€çŸ­çš„æ ‡ç­¾ï¼Œè¡¨ç¤ºè¿™ä¸ªå¤´åƒé€‚ç”¨çš„æƒ…ç»ªæˆ–åœºæ™¯
              </p>
            </div>

            {/* è¯¦ç»†æè¿° */}
            <div>
              <Label>è¯¦ç»†æè¿°</Label>
              <Textarea
                value={newAvatar.description}
                onChange={(e) => setNewAvatar({ ...newAvatar, description: e.target.value })}
                placeholder="è¯¦ç»†æè¿°è¿™ä¸ªå¤´åƒçš„è¡¨æƒ…ã€æƒ…ç»ªå’Œé€‚ç”¨åœºæ™¯ï¼Œå¸®åŠ©AIåˆ¤æ–­ä½•æ—¶ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼šç¬‘å¾—å¾ˆå¼€å¿ƒï¼Œçœ¼ç›å¼¯æˆæœˆç‰™ï¼Œé€‚åˆåœ¨æ”¶åˆ°ç¤¼ç‰©ã€è¢«å¤¸å¥–ã€å¿ƒæƒ…æ„‰æ‚¦çš„æ—¶å€™ä½¿ç”¨"
                rows={4}
                className="mt-2"
              />
              <p className="text-xs text-gray-500 mt-1">
                æè¿°è¶Šè¯¦ç»†ï¼ŒAIè¶Šèƒ½å‡†ç¡®åˆ¤æ–­ä½•æ—¶ä½¿ç”¨è¯¥å¤´åƒ
              </p>
            </div>
          </div>

          <div className="flex gap-2 pt-4 border-t">
            <Button
              type="button"
              variant="outline"
              onClick={() => setShowAddAvatar(false)}
              className="flex-1"
            >
              å–æ¶ˆ
            </Button>
            <Button
              type="button"
              onClick={handleAddAvatarToLibrary}
              className="flex-1"
            >
              æ·»åŠ 
            </Button>
          </div>
        </DialogContent>
      </Dialog>
    </div>
  );
}